<dom-module id="controller-route">
  <script>
    class ControllerRoute extends Polymer.Element {

      static get is() {
        return "controller-route";
      }

      static get properties() {
        return {
          _hashOut: Object,
          routeState: {
            type: Object,
            computed: "_makeRouteState(_hashOut)",
            notify: true
          }
        };
      }

      constructor(){
        super();
        this.set("_hashOut", location.hash.substr(2));
        window.addEventListener("hashchange", this._locationBarChanged.bind(this), false);
      }

      openPage(hash){
        let url = this._concatHash(hash)
        if (url !== this._hashOut)
          window.history.pushState({}, null, '/#/' + url);
      }

      _locationBarChanged(e){
        this.set("_hashOut", location.hash.substr(2));
      }

      _makeRouteState(hash) {
        return {route: this._parseHash(hash)};
      }

      _concatHash(hash) {
        let str = "";
        for (let key in hash.path)
          str += hash.path[key];
        if (hash.query) {
          srt += "?";
          for (let key in hash.query) {
            str += (key + "=" + hash.query[key] + "&");
          }
          str = str.slice(-1);
        }
        return str;
      }

      _parseHash(hash) {
        let Arr = hash.split("?");
        let path = {};
        Arr[0].split("/").forEach(function(each, index) {
          path["segment"+index] = each;
        });
        let query = {};
        if (Arr[1])
          Arr[1].split("&").forEach(function(each) {
            let arr = each.split("=");
            query[arr[0]] = arr[1];
          });
        return {
          path: path,
          query: query
        }
      }
    }
    customElements.define(ControllerRoute.is, ControllerRoute);
  </script>
</dom-module>