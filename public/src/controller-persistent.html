<link rel="import" href="controller-transient.html">
<link rel="import" href="data-firebase.html">

<dom-module id="controller-persistent">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <data-firebase id="firebase"
                   system-books="{{serverSystemBooks}}"
                   server-user="{{serverUser}}"
                   user-data="{{serverUserData}}"

                   on-book-loaded="_bookLoaded"
                   on-system-error="_systemError"></data-firebase>


    <controller-transient id="ui"
                          user="[[serverUser]]"
                          user-data="[[state]]"
                          on-select-book="_selectBook"
                          on-settings-changed="_userSetNewSettings"
                          on-sign-in="_signIn"
                          on-sign-out="_signOut"></controller-transient>
  </template>

  <script>

    class ControllerPersistent extends Polymer.Element {
      static get is() {
        return "controller-persistent";
      }

      //important.
      //1. The structure of the merged serverData and uiData should be identical.
      //2. The structure of the merged serverData should make it as easy as possible to make update calls to the database.
      //   Try to keep the structure of the merged serverData identical to the structure that the update calls conform to
      //   (i.e. identical to the structure on the server).
      static get properties() {
        return {
          serverUser: Object,
          serverSystemBooks: Array,            //data source: firebase database -> change create new object
          serverUserData: Object,              //data source: firebase database -> change create new object
          serverBooks: Object,                 //data source: firebase buckets  -> changes are added to the same object
          serverData: Object,                  //1. process. All data from server are merged
          uiData: LynleserUIData,              //data source: UI
          state: Object                         //2. process. Data from server and UI are merged
        };
      }

      //todo bug in notifyPath and/or computed function.. observers are working
      static get observers() {
        return [
          "_mergeServerData(serverUserData, serverSystemBooks, serverBooks)",
          "_mergeData(serverData, uiData)"
        ];
      }

      constructor() {
        super();
        this.serverBooks = {};
        this.uiData = new LynleserUIData();
      }

      connectedCallback() {
        super.connectedCallback();
        this.__debounceChanges = setInterval(this._tryToPersistChanges.bind(this), 5000);
      }

      _mergeServerData(serverUserData, serverSystemBooks, serverBooks) {
        const res = LynleserServerData.make(serverUserData, serverSystemBooks, serverBooks);
        this.set("serverData", res);
      }

      _mergeData(serverData, uiData) {
        const res = new LynleserData(serverData, uiData);
        console.log(res);
        this.set("state", res);
      }

      _signIn(e) {
        this.uiData = new LynleserUIData();
        this.$.firebase.signIn();
      }

      _signOut(e) {
        this.$.firebase.signOut();
      }

      _selectBook(e) {
        this.$.firebase.getBook(e.detail);
      }

      _systemError(e) {
        console.log("Error");
        console.log(e);
      }

      //todo annoying notifyPath-bug
      //should only use this: this.notifyPath("uiData");
      notifyBug(prop) {
        if (prop == "serverBooks")
          this._mergeServerData(this.serverUserData, this.serverSystemBooks, this.serverBooks);
        if (prop == "uiData")
          this._mergeData(this.serverData, this.uiData);
      }

      _bookLoaded(e) {
        this.serverBooks[e.detail.key] = e.detail.body;
        this.uiData.addSetting({key: "activeBook", value: e.detail.key});
        this.notifyBug("serverBooks");
      }

      _userSetNewSettings(e) {
        this.uiData.addSetting(e.detail);
        this.notifyBug("uiData");
      }

      _tryToPersistChanges() {
        console.log("persisting");
        if (!this.serverUser)
          return;
        const empty = this.uiData.clearRedundant(this.serverUserData);
        if (empty)
          return;
        this.$.firebase.updateChanges(this.uiData);
      }
    }
    customElements.define(ControllerPersistent.is, ControllerPersistent);
  </script>
</dom-module>