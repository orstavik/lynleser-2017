<link rel="import" href="controller-transient.html">
<link rel="import" href="data-firebase.html">

<dom-module id="controller-persistent">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <data-firebase id="firebase"
                   system-books="{{systemBooks}}"
                   server-user="{{serverUser}}"
                   user-data="{{serverUserData}}"
                   server-book="{{serverBook}}"

                   on-system-error="_systemError"></data-firebase>


    <controller-transient id="ui"
                          user="[[serverUser]]"
                          user-data="[[userData]]"
                          on-select-book="_selectBook"
                          on-settings-changed="_userSetNewSettings"
                          on-sign-in="_signIn"
                          on-sign-out="_signOut"></controller-transient>
  </template>

  <script>

    class ControllerPersistent extends Polymer.Element {
      static get is() {
        return "controller-persistent";
      }

      static get properties() {
        return {
          serverUser: Object,
          systemBooks: Array,
          serverUserData: Object,
          serverBook: Object,
          changes: {
            type: DataChanges,
            value: function () {
              return new DataChanges();
            }
          },
          userData: {
            type: Object,
            computed: "_makeUserData(serverUserData, systemBooks, changes, serverBook)" //one argument to computed must be set to invoke at startup
          },
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.__debounceChanges = setInterval(this._tryToPersistChanges.bind(this), 5000);
      }

      _makeUserData(data, books, changes, book) {
        return new LynleserData(data, books, changes, book);
      }

      _signIn(e) {
        this.changes = new DataChanges();
        this.$.firebase.signIn();
      }

      _signOut(e) {
        this.$.firebase.signOut();
      }

      _selectBook(e) {
        this.$.firebase.getBook(e.detail);
      }

      _systemError(e) {
        console.log("Error");
        console.log(e);
      }

      _userSetNewSettings(e) {
        this.changes.addSetting(e.detail);
        //some kind of bug in the notification system, because I have to set the changes to null before it triggers the computed method for the userData
        let c = this.changes;
        this.set("changes", null);
        this.notifyPath("changes", c);
      }

      _tryToPersistChanges() {
        console.log("persisting");
        if (!this.serverUser)
          return;
        const empty = this.changes.clearRedundant(this.serverUserData);
        if (empty)
          return;
        this.$.firebase.updateChanges(this.changes);
      }
    }
    customElements.define(ControllerPersistent.is, ControllerPersistent);
  </script>
</dom-module>