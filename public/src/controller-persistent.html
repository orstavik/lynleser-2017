<link rel="import" href="controller-transient.html">
<link rel="import" href="data-firebase.html">

<dom-module id="controller-persistent">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <data-firebase id="firebase"
                   system-books="{{serverSystemBooks}}"
                   server-user="{{serverUser}}"
                   user-data="{{serverUserData}}"

                   on-book-loaded="_bookLoaded"
                   on-system-error="_systemError"></data-firebase>


    <controller-transient id="ui"
                          user="[[serverUser]]"
                          user-data="[[fullState]]"
                          on-select-book="_selectBook"
                          on-settings-changed="_userSetNewSettings"
                          on-sign-in="_signIn"
                          on-sign-out="_signOut"></controller-transient>
  </template>

  <script>

    class ControllerPersistent extends Polymer.Element {
      static get is() {
        return "controller-persistent";
      }

      //important.
      //1. The structure of the merged serverData and uiData should be as similar as possible,
      //   to make update calls to the DB as simple as possible.
      //3. The order of merging: least updated data source of a branch that are merging are put first.
      //   Branches are merged as late as possible. This produces the fewest updates.
      //4. Immutable. All partial states must be immutable to enable dirty checking.

      static get properties() {
        return {
          serverUser: Object,
          defaultSettings: DefaultSettings,     //             DEFAULT
          serverSystemBooks: Object,            //             DB firebase
          systemUser: SystemUser,               //1. merge
          serverUserData: Object,               //             DB firebase
          userData: UserData,                   //2. merge
          uiDataRaw: RawUIData,                 //             UI changes raw
          uiData: UIData,                       //3. purge
          partialState: PartialState,           //4. merge
          serverBooks: ServerBooks,             //             BUCKETS firebase
          fullState: FullState,                 //5.merge
        };
      }

      static get observers() {
        return [
          "_mergeSystemUser(defaultSettings, serverSystemBooks)", //->systemUser
          "_mergeUserData(systemUser, serverUserData)",           //->userData
          "_purgeUIDataRaw(uiDataRaw, userData)",                 //->uiData
          "_mergeUIData(userData, uiData)",                       //->partialState
          "_mergeState(partialState, serverBooks)",               //->fullState
          "_persistChanges(uiData)"                               //              pass changes to DB
        ];
      }

      constructor() {
        super();
        this.defaultSettings = new DefaultSettings();
        this.serverBooks = new ServerBooks();
        this.uiDataRaw = new RawUIData();
      }

      _mergeSystemUser(defaultSettings, serverSystemBooks) {
        console.log(1);
        this.set("systemUser", new SystemUser(defaultSettings, serverSystemBooks));
      }

      _mergeUserData(systemUserRaw, serverUserData) {
        console.log(3);
        this.set("userData", new UserData(systemUserRaw, serverUserData));
      }

      _purgeUIDataRaw(uiDataRaw, userData) {
        console.log(4);
        this.set("uiData", new UIData(uiDataRaw, userData));
      }

      _mergeUIData(userData, uiData) {
        console.log(5);
        this.set("partialState", new PartialState(userData, uiData));
      }

      _mergeState(partialState, serverBooks) {
        console.log(6);
        this.set("fullState", new FullState(partialState, serverBooks));
      }

      _signIn(e) {
        this.uiDataRaw = new RawUIData();
        this.$.firebase.signIn();
      }

      _signOut(e) {
        this.$.firebase.signOut();
      }

      _selectBook(e) {
        this.uiDataRaw = this.uiDataRaw.addSetting({key: "activeBook", value: e.detail});
        this.$.firebase.getBook(e.detail);
      }

      _systemError(e) {
        console.log("Error");
        console.log(e);
      }

      _bookLoaded(e) {
        this.serverBooks = this.serverBooks.set(e.detail);
      }

      _userSetNewSettings(e) {
        this.uiDataRaw = this.uiDataRaw.addSetting(e.detail);
      }

      _persistChanges(uiData) {
        if (!this.serverUser || !this.uiData || this.uiData.empty)
          return;
        console.log("debounce");
        this.debounce(function () {
          console.log("persisting");
          this.$.firebase.updateChanges(this.uiData);
        }.bind(this), 5000);
      }

      debounce(fn, time) {
        if (this.__bounce)
          clearTimeout(this.__bounce);
        this._bounce = setTimeout(fn, time);
      }
    }
    customElements.define(ControllerPersistent.is, ControllerPersistent);
  </script>
</dom-module>