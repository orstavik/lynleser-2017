<link rel="import" href="controller-transient.html">
<link rel="import" href="lynleser-auth.html">
<link rel="import" href="lynleser-firebase.html">

<script>
  class LynleserUserDataObject {
    constructor(userData, systemBooks) {
      const settings = userData ? userData.settings : null;
      const userBooks = userData ? userData.books : null;
      this.books = new OrganizedBooklist(systemBooks, userBooks);
      this.settings = new LynleserSettingsObject(settings);
    }
  }

  class LynleserSettingsObject {
    constructor(incoming) {
      this.speed = 200;
      this.wordwidth = 14;
      this.prefixes = ["the", "an", "a"];
      this.fontSize = 14;
      this.fontType = "serif";
      this.theme = "day";
      if (incoming)
        Object.assign(this, incoming);
    }
  }

  class OrganizedBooklist {
    constructor(systemBooks, userBooks){
      userBooks = userBooks || {};
      systemBooks = systemBooks || {};
      let userBookKeys = Object.keys(userBooks);
      this.userBooks = userBookKeys.map(key => Object.assign({key: key}, systemBooks[key], userBooks[key]));
      let systemBookKeys = Object.keys(systemBooks);
      let filteredSystemBookKeys = systemBookKeys.filter(systemKey => userBookKeys.indexOf(systemKey));
      this.systemBooks = filteredSystemBookKeys.map(key => Object.assign({key: key}, systemBooks[key]));
    }
  }
</script>

<dom-module id="controller-persistent">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <lynleser-firebase id="firebase"
                       system-books="{{systemBooks}}"
                       server-user="{{serverUser}}"
                       user-data="{{serverUserData}}"

                       on-system-error="_systemError"
                       on-loaded-book="_loadedBook"></lynleser-firebase>

    <lynleser-auth user="[[serverUser]]" on-sign-in="_signIn" on-sign-out="_signOut"></lynleser-auth>

    <controller-transient id="ui"
                          user-data="[[userData]]"
                          on-select-book="_selectBook"
                          on-settings-changed="_userSetNewSettings"></controller-transient>
  </template>

  <script>

    class ControllerPersistent extends Polymer.Element {
      static get is() {
        return "controller-persistent";
      }

      static get properties() {
        return {
          serverUser: Object,
          systemBooks: Array,
          serverUserData: Object,
          userData: Object,
        };
      }

      static get observers() {
        return ["_makeUserData(serverUserData, systemBooks)"];
      }

      connectedCallback(){
        super.connectedCallback();
        this._makeUserData(this.serverUserData, this.systemBooks); //this.serverUserData == undefined && this.serverUserData == undefined
      }

      //todo Here I can make sure that a timestamp of the change on the userData is newer on the server before I replace it.
      //todo If it is not newer, I will try to alert the server of the newer settings on the client.
      _makeUserData(data, books) {
        this.set("userData",new LynleserUserDataObject(data, books));
      }

      _signIn(e) {
        this.$.firebase.signIn();
      }

      _signOut(e) {
        //reset UserData
        this.$.firebase.signOut();
      }

      _selectBook(e) {
        this.$.firebase.getBook(e.detail);
      }

      _loadedBook(e) {
        this.$.ui.loadContent(e.detail);
      }

      _systemError(e) {
        console.log("Error");
        console.log(e);
      }

      _userSetNewSettings(e) {
        //what to do when I'm not logged in?
        //what to do when the user is logged in, but with slow network connection?
        if (this.serverUser)
          this.$.firebase.updateSettings(e.detail);
      }
    }
    customElements.define(ControllerPersistent.is, ControllerPersistent);
  </script>
</dom-module>