<link rel="import" href="controller-transient.html">
<link rel="import" href="data-firebase.html">

<dom-module id="controller-persistent">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <data-firebase id="firebase"
                   system-books="{{serverBookList}}"
                   server-user="{{serverUser}}"
                   user-data="{{serverUserData}}"

                   on-book-loaded="_bookLoaded"
                   on-system-error="_systemError"></data-firebase>


    <controller-transient id="ui"
                          user="[[serverUser]]"
                          user-data="[[fullState]]"
                          on-select-book="_selectBook"
                          on-settings-changed="_userSetNewSettings"
                          on-sign-in="_signIn"
                          on-sign-out="_signOut"></controller-transient>
  </template>

  <script>

    class ControllerPersistent extends Polymer.Element {
      static get is() {
        return "controller-persistent";
      }

      //important.
      //1. The structure of the merged serverData and uiData should be as similar as possible,
      //   to make update calls to the DB as simple as possible.
      //3. The order of merging: least updated data source of a branch that are merging are put first.
      //   Branches are merged as late as possible. This produces the fewest updates.
      //4. Immutable. All partial states must be immutable to enable dirty checking.

      static get properties() {
        return {
          serverUser: Object,
          defaultState: {                                       //             a. DEFAULT
            type: DefaultState,
            value: function(){
              return new DefaultState();
            }
          },
          serverBookList: Object,                               //             b. DB firebase
          genericUserState: {                                   //             1. merge
            type: GenericUserState,
            computed: "_mergeSystemUser(defaultState, serverBookList)"
          },
          serverUserData: Object,                               //             c. DB firebase
          specificUser: {                                       //             2. merge
            type: SpecificUser,
            computed:"_mergeUserData(genericUserState, serverUserData)"
          },
          uiDataRaw: {                                          //             d. UI changes raw
            type: RawUIData,
            value: function(){
              return new RawUIData();
            }
          },
          uiData: {                                             //             3. purge
            type: UIData,
            computed: "_purgeUIDataRaw(uiDataRaw, specificUser)",
            observer: "_persistChanges"
          },
          partialState: {                                       //             4. merge
            type: PartialState,
            computed:  "_mergeUIData(specificUser, uiData)"
          },                                                    
          serverBooks: {                                        //             e. BUCKETS firebase
            type: ServerBooks,
            value: function(){
              return new ServerBooks();
            }
          },
          fullState: {                                          //             5.merge
            type: FullState,
            computed: "_mergeState(partialState, serverBooks)"
          },
        };
      }

      _mergeSystemUser(defaultSettings, serverBookList) {
        console.log(1 + " " + new Date().getTime());
        return new GenericUserState(defaultSettings, serverBookList);
      }

      _mergeUserData(genericUserState, serverUserData) {
        console.log(2 + " " + new Date().getTime());
        return new SpecificUser(genericUserState, serverUserData);
      }

      _purgeUIDataRaw(RawUIData, specificUser) {
        console.log(3 + " " + new Date().getTime());
        return new UIData(RawUIData, specificUser);
      }

      _mergeUIData(specificUser, uiData) {
        console.log(4 + " " + new Date().getTime());
        return new PartialState(specificUser, uiData);
      }

      _mergeState(partialState, bookData) {
        console.log(5 + " " + new Date().getTime());
        return new FullState(partialState, bookData);
      }

      _signIn(e) {
        this.uiDataRaw = new RawUIData();
        this.$.firebase.signIn();
      }

      _signOut(e) {
        this.$.firebase.signOut();
      }

      _selectBook(e) {
        this.uiDataRaw = this.uiDataRaw.addSetting({key: "activeBook", value: e.detail});
        this.$.firebase.getBook(e.detail);
      }

      _systemError(e) {
        console.log("Error");
        console.log(e);
      }

      _bookLoaded(e) {
        this.serverBooks = this.serverBooks.set(e.detail);
      }

      _userSetNewSettings(e) {
        this.uiDataRaw = this.uiDataRaw.addSetting(e.detail);
      }

      _persistChanges(uiData) {
        if (!this.serverUser || !this.uiData || this.uiData.empty)
          return;
        console.log("debounce");
        this.debounce(function () {
          console.log("persisting");
          this.$.firebase.updateChanges(this.uiData);
        }.bind(this), 5000);
      }

      debounce(fn, time) {
        if (this.__bounce)
          clearTimeout(this.__bounce);
        this._bounce = setTimeout(fn, time);
      }
    }
    customElements.define(ControllerPersistent.is, ControllerPersistent);
  </script>
</dom-module>