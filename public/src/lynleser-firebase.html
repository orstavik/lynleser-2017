<dom-module id="lynleser-firebase">
  <script>

    class UserDataObject {
      constructor(rawData) {
        this._raw = rawData;
        this.settings = rawData.settings;
        this.books = LynleserFirebase._firebaseArrayToJSArray(rawData.books);
      }
    }

    class LynleserFirebase extends Polymer.Element {
      static get is() {
        return "lynleser-firebase";
      }

      static get config() {
        return {
          properties: {
            serverUser: {
              type: Object,
              observer: "_serverUserChanged",
              notify: true
            },
            _serverSystemBooks: Object,
            systemBooks: {
              type: Array,
              notify: true,
              computed: "_makeSystemBooks(_serverSystemBooks)"
            },
            _serverUserData: Object,
            userData: {
              type: UserDataObject,
              notify: true,
              computed: "_makeUserData(_serverUserData)"
            }
          }
        };
      }

      connectedCallback() {
        firebase.initializeApp({
          apiKey: "AIzaSyCsaCy5xQKr7-H23fvHZX9vbZklxo4mKks",
          authDomain: "lynleser-2017.firebaseapp.com",
          databaseURL: "https://lynleser-2017.firebaseio.com",
          storageBucket: "lynleser-2017.appspot.com",
          messagingSenderId: "740631213903"
        });
        this._db = firebase.database();
        this.systemBooksListener = this._db.ref("/system/books/");
        this.systemBooksListener.on("value", this._updateSystemBooks.bind(this));
      }

      getBook(fileName) {
        let fileRef = firebase.storage().ref('books/' + fileName);
        fileRef.getDownloadURL().then(function (url) {
          // This can be downloaded directly:
          let xhr = new XMLHttpRequest();
          xhr.responseType = 'document';
          xhr.onload = function (event) {
            this.dispatchEvent(new CustomEvent("loaded-book", {composed: true, bubbles: true, detail: xhr.response}));
          }.bind(this);
          xhr.open('GET', url);
          xhr.send();
        }.bind(this)).catch(this._systemError.bind(this));
      }

      _makeUserData(obj) {
        return obj ? new UserDataObject(obj) : null;
      }

      _makeSystemBooks(obj) {
        return LynleserFirebase._firebaseArrayToJSArray(obj);
      }

      _updateSystemBooks(snap) {
        this.set("_serverSystemBooks", snap.val());
      }

      _updateUserData(snap) {
        this.set("_serverUserData", snap.val());
      }

      _serverUserChanged(user) {
        if (!user) {
          this.set("_serverUserData", null);
          if (this.userDataListener)
            this.userDataListener.off();
        } else {
          this.userDataListener = this._db.ref("/users/" + user.uid);
          this.userDataListener.on("value", this._updateUserData.bind(this));
        }
      }

      signIn(e) {
        let provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).then(function (result) {
          // This gives you a Google Access Token. You can use it to access the Google API.
          // let token = result.credential.accessToken;
          this.set("serverUser", result.user);
        }.bind(this)).catch(this._systemError.bind(this));
      }

      signOut(e) {
        firebase.auth().signOut().then(function () {
          this.set("serverUser", null);
        }.bind(this)).catch(this._systemError.bind(this));
      }

      _systemError(error){
        this.dispatchEvent(new CustomEvent("system-error", {composed: true, bubbles: true, detail: error}));
      }

      static _firebaseArrayToJSArray(obj) {
        if (!obj)
          return null;
        return Object.keys(obj).map(function (key) {
          return {key: key, value: obj[key]};
        });
      }
    }
    customElements.define(LynleserFirebase.is, LynleserFirebase);
  </script>
</dom-module>