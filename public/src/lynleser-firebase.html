<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<dom-module id="lynleser-firebase">
  <template>
    <style>
      :host { display: block; }
    </style>

    <firebase-app
        name="lynleser"
        api-key="AIzaSyCsaCy5xQKr7-H23fvHZX9vbZklxo4mKks"
        auth-domain="lynleser-2017.firebaseapp.com"
        database-url="https://lynleser-2017.firebaseio.com/"
    ></firebase-app>

    <firebase-auth id="auth" app-name="lynleser" user="{{serverUser}}" provider="google"></firebase-auth>

  </template>
  <script>

    class UserDataObject {
      constructor(rawData) {
        this._raw = rawData;
        this.settings = rawData.settings;
        this.books = LynleserFirebase._firebaseArrayToJSArray(rawData.books);
      }
    }

    class LynleserFirebase extends Polymer.Element {
      static get is() {
        return "lynleser-firebase";
      }


      static get config() {
        return {
          properties: {
            serverUser: {
              type: Object,
              observer: "_serverUserChanged",
              notify: true
            },
            _serverSystemBooks: Object,
            systemBooks: {
              type: Array,
              notify: true,
              computed: "_makeSystemBooks(_serverSystemBooks)"
            },
            _serverUserData: Object,
            userData: {
              type: UserDataObject,
              notify: true,
              computed: "_makeUserData(_serverUserData)"
            }
          },
          //observers: []
        };
      }

      _makeUserData(obj) {
        return obj ? new UserDataObject(obj) : null;
      }

      _makeSystemBooks(obj) {
        return LynleserFirebase._firebaseArrayToJSArray(obj);
      }

      connectedCallback() {
        this._db = firebase.app("lynleser").database();
        this.systemBooksListener = this._db.ref("/system/books/");
        this.systemBooksListener.on("value", this._updateSystemBooks.bind(this));
      }

      _updateSystemBooks(snap) {
        this.set("_serverSystemBooks", snap.val());
//        console.log("got a system book list");
//        console.log(this.systemBooks);
      }

      _updateUserData(snap) {
        this.set("_serverUserData", snap.val());
//        console.log("got user data");
//        console.log(this.userData);
      }

      _serverUserChanged(user) {
        if (!user) {
          this.set("_serverUserData", null);
          if (this.userDataListener)
            this.userDataListener.off();
        } else {
          this.userDataListener = this._db.ref("/users/" + user.uid);
          this.userDataListener.on("value", this._updateUserData.bind(this));
        }
      }

      signIn(e) {
        this.$.auth.signInWithPopup();
      }

      signOut(e) {
        this.$.auth.signOut();
      }

      static _firebaseArrayToJSArray(obj) {
        if (!obj)
          return null;
        return Object.keys(obj).map(function (key) {
          return {key: key, value: obj[key]};
        });
      }
    }
    customElements.define(LynleserFirebase.is, LynleserFirebase);
  </script>
</dom-module>