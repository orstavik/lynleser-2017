<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<dom-module id="data-firebase">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <app-indexeddb-mirror
        key="bookList"
        data="{{fbGenericState}}"
        persisted-data="{{genericState}}">
    </app-indexeddb-mirror>
  </template>
  <script>

    class DataFirebase extends Polymer.Element {
      static get is() {
        return "data-firebase";
      }

      static get properties() {
        return {
          serverUser: {
            type: Object,
            observer: "_serverUserChanged",
            notify: true
          },
          genericState: {
            type: Object,
            notify: true
          },
          fbGenericState: Object,
          serverBooks: {
            type: Object,
            notify: true
          },
          userState: {
            type: Object,
            notify: true
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.set("serverBooks", {});
        this._db = firebase.database();
        this._db.ref("/system/books/").once("value", function (snap) {
          this.set("fbGenericState", {books: snap.val()});
        }.bind(this));
      }

      getBook(book) {
        console.log("getBook first");
        if (this.serverBooks[book.key])
          return;
        console.log("getBook for real");
        const fileName = book.fileName;
        const key = book.key;
        //todo try to get serverBooks from indexeddb
        let fileRef = firebase.storage().ref('books/' + fileName);
        fileRef.getDownloadURL().then(function (url) {
          // This can be downloaded directly:
          let xhr = new XMLHttpRequest();
          xhr.responseType = 'document';
          xhr.onload = function (event) {
            const res = Object.assign({}, this.serverBooks);
            res[key] = {key: key, fileName: fileName, body: xhr.response};
            //todo add xhr.response to indexeddb
            this.set("serverBooks", res);
          }.bind(this);
          xhr.open('GET', url);
          xhr.send();
        }.bind(this)).catch(this._systemError.bind(this));
      }

      _updateUserData(snap) {
        this.set("userState", snap.val());
      }

      _serverUserChanged(user) {
        if (!user) {
//          this.set("_serverUserData", null);
          if (this.userStateListener)
            this.userStateListener.off();
        } else {
          this.checkIfFirstTimeUser(user);
          this.userStateListener = this._db.ref("/users/" + user.uid);
          this.userStateListener.on("value", this._updateUserData.bind(this));
        }
      }

      signIn(e) {
        let provider = new firebase.auth.GoogleAuthProvider();
        firebase.auth().signInWithPopup(provider).then(function (result) {
          // This gives you a Google Access Token. You can use it to access the Google API.
          // let token = result.credential.accessToken;
          this.set("serverUser", result.user);
          //todo load the serverBook and serverUserData
        }.bind(this)).catch(this._systemError.bind(this));
      }


      checkIfFirstTimeUser(user) {
        const userDataInDB = this._db.ref("/users/" + user.uid);
        userDataInDB.once("value",
          function (success) {
            if (!success.exists()) {                //user not registered before
              userDataInDB.set({registered: firebase.database.ServerValue.TIMESTAMP});
              this.systemMessage("Welcome new user!");
            }
          }.bind(this), this._systemError.bind(this));
      }

      signOut(e) {
        firebase.auth().signOut().then(function () {
          this.set("serverUserState", null);
          this.set("serverUser", null);
        }.bind(this)).catch(this._systemError.bind(this));
      }

      _systemError(error) {
        this.dispatchEvent(new CustomEvent("system-error", {composed: true, bubbles: true, detail: error}));
      }

      updateSettings(newSettings) {
        let updates = {};
        updates["/users/" + this.serverUser.uid + "/settings/" + newSettings.type] = newSettings.value;
        this._db.ref().update(updates, function () {
          this.systemMessage("updated settings: " + newSettings.type + " = " + newSettings.value);
        }.bind(this));
      }

      updateChanges(changes) {
        if (!this.serverUser || !this.serverUser.uid)
          return;
        const updates = {};
        for (let s of Object.keys(changes.settings))
          updates["/users/" + this.serverUser.uid + "/settings/" + s] = changes.settings[s];
        this._db.ref().update(updates, function () {
          this.systemMessage("updated changes: " + Object.keys(changes.settings));
        }.bind(this));
      }

      systemMessage(str) {
        this.dispatchEvent(new CustomEvent("system-message", {composed: true, bubbles: true, detail: str}));
      }
    }
    customElements.define(DataFirebase.is, DataFirebase);
  </script>
</dom-module>