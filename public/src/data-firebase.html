<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="firebase-on.html">
<link rel="import" href="firebase-loginout.html">

<dom-module id="data-firebase">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <app-indexeddb-mirror key="genericState"
                          data="{{fbGenericState}}"
                          persisted-data="{{genericState}}"></app-indexeddb-mirror>
    <firebase-on id="serverUserState"
                 active="[[serverUser]]"
                 path="/users/[[serverUser.uid]]"
                 result="{{userState}}"
                 on-found-no-data="_newUser"></firebase-on>
    <firebase-on once
                 active
                 path="/system/books"
                 result="{{systemBooks}}"></firebase-on>
    <firebase-loginout id="auth" user="{{serverUser}}"></firebase-loginout>
  </template>
  <script>

    class DataFirebase extends Polymer.Element {
      static get is() {
        return "data-firebase";
      }

      static get properties() {
        return {
          serverUser: {
            type: Object,
            notify: true
          },
          systemBooks: Object,
          genericState: {
            type: Object,
            computed: "_makeGenericState(systemBooks)",
            notify: true
          },
          fireGenericState: Object,
          serverBooks: {
            type: Object,
            value: function () {
              return {};
            },
            notify: true
          },
          userState: {
            type: Object,
            notify: true
          }
        };
      }

      getBook(book) {
        if (this.serverBooks[book.key])
          return;
        let fileRef = firebase.storage().ref('books/' + book.fileName);
        fileRef.getDownloadURL().then(function (url) {
          let xhr = new XMLHttpRequest();
          xhr.responseType = 'document';
          xhr.onload = function (event) {
            const res = Object.assign({}, this.serverBooks);
            res[book.key] = {key: book.key, fileName: book.fileName, body: xhr.response};
            this.set("serverBooks", res);
          }.bind(this);
          xhr.open('GET', url);
          xhr.send();
        }.bind(this)).catch(this._fire.bind(this, "system-error"));
      }

      _makeGenericState(books) {
        return books ? {books: books} : undefined;
      }

      signIn() {
        this.$.auth.signIn();
      }

      signOut() {
        this.$.auth.signOut();
      }

      _newUser(e) {
        debugger;
        this.$.serverUserState.updateOverwrite({registered: firebase.database.ServerValue.TIMESTAMP});
        this._fire("system-message", "Welcome new user!");
      }

      updateChanges(changes) {
        this.$.serverUserState.updateMerge(changes);
      }

      _fire(name, detail){
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }
    }
    customElements.define(DataFirebase.is, DataFirebase);
  </script>
</dom-module>