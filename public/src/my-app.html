<link rel="import" href="controller-transient.html">
<link rel="import" href="lynleser-auth.html">
<link rel="import" href="lynleser-firebase.html">

<script>
  class LynleserUserDataObject {
    constructor(incoming) {
      if (incoming) {
        this.books = incoming.books;
        this.settings = new LynleserSettingsObject(incoming.settings);
      } else {
        this.books = null;
        this.settings = new LynleserSettingsObject(null);
      }
      console.log(incoming);
      console.log(this);
    }
  }

  class LynleserSettingsObject {
    constructor(incoming) {
      this.speed = 200;
      this.wordwidth = 14;
      this.prefixes = ["the", "an", "a"];
      this.fontSize = 14;
      this.fontType = "serif";
      this.theme = "day";
      if (incoming)
        Object.assign(this, incoming);
    }
  }

</script>

<dom-module id="my-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <lynleser-firebase id="firebase"
                       system-books="{{systemBooks}}"
                       server-user="{{serverUser}}"
                       user-data="{{serverUserData}}"

                       on-system-error="_systemError"
                       on-loaded-book="_loadedBook"></lynleser-firebase>

    <lynleser-auth user="[[serverUser]]" on-sign-in="_signIn" on-sign-out="_signOut"></lynleser-auth>

    <controller-transient id="ui"
                          system-books="[[systemBooks]]"
                          user-data="[[userData]]"
                          on-select-book="_selectBook"
                          on-settings-changed="_userSetNewSettings"></controller-transient>
  </template>

  <script>

    class MyApp extends Polymer.Element {
      static get is() {
        return "my-app";
      }

      static get properties() {
        return {
          serverUser: Object,
          systemBooks: Array,
          serverUserData: {
            type: Object,
            observer: "_makeUserData"
          },
          userData: Object,
        };
      }

      connectedCallback(){
        super.connectedCallback();
        this._makeUserData(this.serverUserData); //this.serverUserData == null
      }

      _makeUserData() {
        //todo Here I can make sure that a timestamp of the change on the userData is newer on the server before I replace it.
        //todo If it is not newer, I will try to alert the server of the newer settings on the client.
        this.set("userData",new LynleserUserDataObject(this.serverUserData));
      }

      _signIn(e) {
        this.$.firebase.signIn();
      }

      _signOut(e) {
        //reset UserData
        this.$.firebase.signOut();
      }

      _selectBook(e) {
        this.$.firebase.getBook(e.detail);
      }

      _loadedBook(e) {
        this.$.ui.loadContent(e.detail);
      }

      _systemError(e) {
        console.log("Error");
        console.log(e);
      }

      _userSetNewSettings(e) {
        if (this.serverUser)
          this.$.firebase.updateSettings(e.detail);
      }
    }
    customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>