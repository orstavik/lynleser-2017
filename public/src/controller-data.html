<link rel="import" href="../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="firebase-on.html">
<link rel="import" href="firebase-loginout.html">
<link rel="import" href="firebase-bucket.html">

<dom-module id="controller-data">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    <app-indexeddb-mirror id="indexDB"
                          key="systemBooks"
                          data="{{serverSystemBooks}}"
                          persisted-data="{{systemBooks}}"></app-indexeddb-mirror>
    <firebase-on id="serverUserState"
                 active="[[serverUser]]"
                 path="/users/[[serverUser.uid]]"
                 result="{{userState}}"
                 on-found-no-data="_newUser"></firebase-on>
    <firebase-on active
                 path="/system/books"
                 result="{{serverSystemBooks}}"></firebase-on>
    <firebase-loginout id="auth" user="{{serverUser}}"></firebase-loginout>
    <firebase-bucket id="bucket" root-path="books/" result="{{bookData}}"></firebase-bucket>
  </template>
  <script>

    class ControllerData extends Polymer.Element {
      static get is() {
        return "controller-data";
      }

      static get properties() {
        return {
          serverUser: {
            type: Object,
            notify: true
          },
          serverSystemBooks: Object,
          systemBooks: {
            type: Object,
            notify: true
          },
          books: {
            type: Object,
            notify: true,
            computed: "_makeStateWithSystemBookData(systemBooks, bookData)"
          },
          bookData: {
            type: Object,
            notify: true
          },
          userState: {
            type: Object,
            notify: true
          },
          mergedUserState: {
            type: Object,
            computed: "_makeMergedUserState(userState, serverUser)",
            notify: true
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this.$.indexDB.getStoredValue().then((books) => this.set("systemBooks", books));
      }

      getBook(book) {
        this.$.bucket.loadData(book.key, book.fileName);
      }

      _makeStateWithSystemBookData(systemBooks, bookData) {
        const A = {books: systemBooks};
        if (!bookData) return A;
        const B = {books: bookData};
        if (!systemBooks) return B;
        return Tools.mergeDeep(A, B);
      }

      _makeMergedUserState(userState, serverUser) {
        return serverUser ? Object.assign({}, userState, {user: serverUser}) : undefined;
      }

      signIn() {
        this.$.auth.signIn();
      }

      signOut() {
        this.$.auth.signOut();
      }

      _newUser(e) {
        this.$.serverUserState.updateOverwrite({registered: firebase.database.ServerValue.TIMESTAMP});
        this._fire("system-message", "Welcome new user!");
      }

      updateChanges(changes) {
        this.$.serverUserState.updateMerge(changes);
      }

      _fire(name, detail) {
        this.dispatchEvent(new CustomEvent(name, {composed: true, bubbles: true, detail: detail}));
      }
    }
    customElements.define(ControllerData.is, ControllerData);
  </script>
</dom-module>